<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>WebRTC Video Stream</title>
    <style>
        #control-panel { display: none; margin-top: 20px; }
        #joystick-zone { width: 200px; height: 200px; margin: 0 auto; }
        .action-btn { width: 120px; font-size: 1em; margin: 10px; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/nipplejs@0.9.0/dist/nipplejs.min.js"></script>
</head>
<body>
    <h2>실시간 비디오 스트림</h2>
    <img src="{{ url_for('video_feed') }}" width="640" height="360" />

    <br>
    <button id="slam-btn">START CONTROL</button>
    <button id="exit-btn" style="display:none;">EXIT</button>

    <div id="control-panel">
        <div id="joystick-zone"></div>
        <div style="margin-top:20px;">
            <button class="action-btn" onclick="move('sitdown')">SIT DOWN</button>
            <button class="action-btn" onclick="move('situp')">STAND UP</button>
        </div>
    </div>

    <script>
        let joystick = null;
        let current = {x: 0, z: 0};
        let sending = false;
        let intervalId = null;

        document.getElementById('slam-btn').onclick = function() {
            fetch('/start_control', {method: 'POST'})
                .then(res => res.json())
                .then(data => {
                    document.getElementById('control-panel').style.display = 'block';
                    document.getElementById('slam-btn').style.display = 'none';
                    document.getElementById('exit-btn').style.display = 'inline-block';
                    if (!joystick) {
                        createJoystick();
                    }
                });
        };

        document.getElementById('exit-btn').onclick = function() {
            document.getElementById('control-panel').style.display = 'none';
            document.getElementById('slam-btn').style.display = 'inline-block';
            document.getElementById('exit-btn').style.display = 'none';
            stopSending();
        };

        function move(direction) {
            fetch('/move', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ direction: direction })
            });
        }

        function createJoystick() {
            joystick = nipplejs.create({
                zone: document.getElementById('joystick-zone'),
                mode: 'static',
                position: { left: '50%', top: '50%' },
                color: 'blue',
                size: 150
            });

            joystick.on('move', function(evt, data) {
                if (data && data.distance > 10) {
                    let rad = data.angle.radian;
                    // y축(세로) → x(전후), x축(가로) → z(회전)
                    let x = Math.sin(rad) * (data.distance / 100); // -1 ~ 1 (전후)
                    let z = Math.cos(rad) * (data.distance / -75); // -1 ~ 1 (회전)
                    current.x = x;
                    current.z = z;
                } else {
                    current.x = 0;
                    current.z = 0;
                }
                if (!sending) startSending();
            });

            joystick.on('end', function() {
                current.x = 0;
                current.z = 0;
                sendJoy(0, 0);
                stopSending();
            });
        }

        function startSending() {
            sending = true;
            if (intervalId) return;
            intervalId = setInterval(() => {
                sendJoy(current.x, current.z);
            }, 50); // 50ms마다 전송
        }

        function stopSending() {
            sending = false;
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
            }
        }

        function sendJoy(x, z) {
            fetch('/joystick', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ x: x, z: z })
            });
        }
    </script>
</body>
</html>